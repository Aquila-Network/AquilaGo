package main

import (
	"crypto"
	"crypto/rand"
	"crypto/rsa"
	"crypto/sha512"
	"crypto/x509"
	"encoding/pem"
	"fmt"
	"io/ioutil"

	"github.com/mr-tron/base58/base58"
	"gopkg.in/mgo.v2/bson"
)

type Person struct {
	Name  string
	Phone string
}

type CreateAquilaResponsStruct struct {
	DatabaseName string `json:"database_name" bson:"database"`
	Success      bool   `json:"success" bson:"success"`
}

type MetadataStructCreateDb struct {
	Name string `json:"name"`
	Age  string `json:"age"`
}

type SchemaStruct struct {
	Description string                 `json:"description" bson:"description"`
	Unique      string                 `json:"unique"`
	Encoder     string                 `json:"encoder"`
	Codelen     int                    `json:"codelen"`
	Metadata    MetadataStructCreateDb `json:"metadata"`
}

type DataStructCreateDb struct {
	Schema SchemaStruct `json:"schema"`
}

func main() {

	requestStructure := DataStructCreateDb{
		Schema: SchemaStruct{
			Description: "this is my database",
			Unique:      "r8and0mseEd901",
			Encoder:     "strn:msmarco-distilbert-base-tas-b",
			Codelen:     768,
			Metadata: MetadataStructCreateDb{
				Name: "string",
				Age:  "number",
			},
		},
	}

	bson_data, err := bson.Marshal(requestStructure)
	if err != nil {
		panic(err)
	}
	fmt.Printf("%x\n", bson_data) // Right !!!

	bytes := sha512.Sum384(bson_data)
	// fmt.Printf("%x\n", bytes) // Right !!!

	priv, _ := ioutil.ReadFile("/home/dev/aquilax/ossl/private_unencrypted.pem")
	privPem, _ := pem.Decode(priv)
	privPemBytes := privPem.Bytes

	priv1, _ := x509.ParsePKCS1PrivateKey([]byte(privPemBytes))
	signature, _ := rsa.SignPKCS1v15(rand.Reader, priv1, crypto.SHA384, bytes[:]) // Right !!!

	num := base58.Encode(signature)
	fmt.Println("==========================")
	fmt.Println(num) // Right !!!!!!
}

/*

// Response
5JNkAvWL6AdtbYmNQrBUxWubEDQp6bZzw3zf8djxSRzg8pywE5wgs8ufj7TrJ6uK71wDZTWEcTJYT4bDU5v5nQgY5aopwvRySmBmu1HYLYBGTNRQTQ81QRpjF1pvxBtHn1NrWipTo6kxVvJZURY9kfwv9oweTvv2Xt6FAPx9VaZgo8g6YTxEBLyVnrhvsKE7QmZuUd4sSgXQ3zm9fYB3f6v5RdprtCuUqUEAzs7ZecGSvDzc8kNMF7DkQajJnjbcYPQAiNMgaPtnrrArofYNjwxsecZngA7eTU1d5XQwnWAgKvpJ9xMXNRg41uz4CRpUyDs8YFNtvMQbpLkc5MJA2UgrBcxscc

*/